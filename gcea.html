<!doctype html>

<!-- TODO: change diagram to SVG -->
<!-- TODO: add scales (for each chord?) -->


<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>gcea</title>
<style>
  :root {
    /* Light mode palette */
    --color-bg: #f8f8f8;
    --color-text: #2d5016;
    --color-primary: #2d5016;
    --color-primary-text: #ffffff;
    --color-secondary-bg: #d0d0d0;
    --color-secondary-text: #2d5016;
    --color-border: #b0b0b0;
    --color-card-bg: #f5f5f5;
    --color-shadow: rgba(0,0,0,0.1);

    /* Control surfaces */
    --color-input-bg: var(--color-card-bg);

    /* Diagram colors */
    --color-canvas-bg: #f5f5f5;
    --color-canvas-bg-dark: #1a2d10;
    --color-string: #5a8b3f;
    --color-fret: #b0b0b0;
    --color-label: #0c4666;
    --color-dot: #2d5016;
    --color-muted: #c63a2b;
    --color-dot-text: #ffffff;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg: #1a2d10;
      --color-text: #f8f8f8;
      --color-primary: #f8f8f8;
      --color-primary-text: #2d5016;
      --color-secondary-bg: #3a6b1f;
      --color-secondary-text: #f8f8f8;
      --color-border: #5a8b3f;
      --color-card-bg: #1a2d10;
      --color-shadow: rgba(0,0,0,0.5);

      --color-input-bg: var(--color-card-bg);
    }
  }

  /* desktop */
  @media (min-width: 768px) {
  
  }

  /* mobile */
  @media (max-width: 480px) {
    
  }

  /* tablet */
  @media (min-width: 480px) and (max-width: 768px) {
    
  }

  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    margin: 0;
    background: var(--color-bg);
    color: var(--color-text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }

  h1 { font-size:28px; margin:0; color: var(--color-text); }
  .controls, label { 
    display:flex; 
    gap:8px; 
    flex-wrap:wrap; 
    align-items:center; 
    font-size: 16px;
  }
  button, label {
    background: var(--color-primary);
    color: var(--color-primary-text);
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  button.secondary, label.secondary {
    background: var(--color-secondary-bg);
    color: var(--color-secondary-text);
    border: 1px solid var(--color-border);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 16px;
  }
  label.small {
    background: none;
    color: var(--color-text);
    padding: 0;
  }

  .card {
    background: var(--color-card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 10px var(--color-shadow);
    padding: 90px 32px;
    width: 100%;
    max-width: 560px;
    margin: 0 auto;
  }

  .chord-title {
    font-size: 80px;
    font-weight: 900;
    margin: 8px 0;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .small { font-size: 13px; color: var(--color-text); }
  .row { display: flex; gap: 12px; align-items: center; margin-top: 12px; flex-wrap: wrap; }

  canvas {
    background: var(--color-canvas-bg);
    border-radius: 8px;
  }
  @media (prefers-color-scheme: dark) {
    canvas { background: var(--color-canvas-bg-dark); }
  }

  select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-input-bg);
    color: var(--color-text);
  }

  input[type="checkbox"] { width: 16px; height: 16px; }

  #tipRow { transition: opacity 0.5s ease-out; }
  #tipRow.fade-out { opacity: 0; }
  main { display: flex; justify-content: center; width: 100%; }
  footer { margin-top: 14px; font-size: 12px; color: var(--color-text); }
</style>
</head>
<body>
<main>
  <section class="card" aria-live="polite">
    <div style="display:flex;gap:16px;justify-content:space-between;align-items:flex-start;">
      <div>
        <div class="chord-title" id="chordName">C</div>
        <div class="small" id="chordType">Major â€” Root position</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:12px;min-width:200px;text-align:right;">
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
          <label class="small" style="display:flex;gap:8px;align-items:center;">
            <input id="showFingering" type="checkbox">Show fingering
          </label>
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
          <select id="scale" title="Pick chord set">
            <option value="all">All chords</option>
            <option value="maj">Major only</option>
            <option value="min">Minor only</option>
            <option value="seventh">Sevenths</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
          <label class="small">Strum style:</label>
          <select id="strumStyle" class="secondary">
            <option value="down">Down strum</option>
            <option value="arpeggio">Arpeggio</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row">
      <canvas id="diagram" width="400" height="450" style="display:none"></canvas>
    </div>

    <div style="display:flex;align-items:center;gap:12px;margin-top:16px;">
      <div class="controls">
        <label class="secondary" title="Auto advance every 5s">
          <input id="autoAdvance" type="checkbox" style="margin:0px 8px 0px 0px">Auto
        </label>
        <button id="prev" class="secondary">Previous</button>
        <button id="next" class="secondary">Next</button>
        <button id="play" class="secondary">Replay</button>
      </div>
    </div>

    <div class="row" id="tipRow">
      <div class="small">Tip: Click Next or press space to get a new chord.</div>
    </div>
  </section>
  <footer></footer>
</main>

<script>
/* --- Data: chords in standard ukulele tuning G4 C4 E4 A4 (strings 4 -> 1). */
const CHORDS = [
    { name:"C", type:"Major", fingering:[0,0,0,3] },
    { name:"Cmaj7", type:"Major7", fingering:[0,0,0,2] },
    { name:"Cm7", type:"Minor7", fingering:[3,3,3,3] },
    { name:"C7", type:"Seventh", fingering:[0,0,0,1] },
    { name:"Csus2", type:"Suspended", fingering:[0,0,0,0] },
    { name:"Csus4", type:"Suspended", fingering:[0,0,0,1] },

    { name:"G", type:"Major", fingering:[0,2,3,2] },
    { name:"Gmaj7", type:"Major7", fingering:[0,2,2,2] },
    { name:"Gm7", type:"Minor7", fingering:[0,2,1,3] },
    { name:"G7", type:"Seventh", fingering:[0,2,1,2] },
    { name:"Gdim", type:"Diminished", fingering:[2,3,2,3] },
    { name:"Gsus4", type:"Suspended", fingering:[0,2,3,0] },

    { name:"Am", type:"Minor", fingering:[2,0,0,0] },
    { name:"Am7", type:"Minor7", fingering:[0,0,0,0] },
    { name:"Amaj7", type:"Major7", fingering:[1,1,1,0] },
    { name:"Am9", type:"Minor9", fingering:[2,0,0,2] },
    { name:"A7", type:"Seventh", fingering:[0,1,0,0] },

    { name:"F", type:"Major", fingering:[2,0,1,0] },
    { name:"Fmaj7", type:"Major7", fingering:[2,0,1,0] },
    { name:"Fm7", type:"Minor7", fingering:[3,1,1,1] },
    { name:"Fdim", type:"Diminished", fingering:[3,2,3,2] },
    { name:"Fsus2", type:"Suspended", fingering:[2,0,0,0] },

    { name:"D", type:"Major", fingering:[2,2,2,0] },
    { name:"Dmaj7", type:"Major7", fingering:[2,2,2,2] },
    { name:"Dm7", type:"Minor7", fingering:[2,2,1,0] },
    { name:"D7", type:"Seventh", fingering:[2,2,2,3] },
    { name:"Ddim", type:"Diminished", fingering:[2,1,2,1] },

    { name:"E", type:"Major", fingering:[1,4,0,2] },
    { name:"Emaj7", type:"Major7", fingering:[1,4,1,2] },
    { name:"Em", type:"Minor", fingering:[0,4,3,2] },
    { name:"Em7", type:"Minor7", fingering:[0,4,3,0] },
    { name:"Edim", type:"Diminished", fingering:[1,0,1,0] },

    { name:"A", type:"Major", fingering:[2,1,0,0] },
    { name:"A7", type:"Seventh", fingering:[0,1,0,0] },
    { name:"Am", type:"Minor", fingering:[2,0,0,0] },
    { name:"Am7", type:"Minor7", fingering:[2,0,0,0] },
    { name:"Adim", type:"Diminished", fingering:[2,1,2,1] },

    { name:"Bm", type:"Minor", fingering:[4,2,2,2] },
    { name:"Bm7", type:"Seventh", fingering:[2,2,2,2] },
    { name:"Bdim", type:"Diminished", fingering:[3,2,3,2] },

    { name:"F#m", type:"Minor", fingering:[4,4,3,2] },
    { name:"F#m7", type:"Minor7", fingering:[2,2,2,2] },
    { name:"F#dim", type:"Diminished", fingering:[1,0,1,0] },

    { name:"Cadd9", type:"Add9", fingering:[0,0,0,0] },
    { name:"Gadd9", type:"Add9", fingering:[2,2,3,2] },
    { name:"Dsus4", type:"Suspended", fingering:[2,2,3,0] }
];

/* --- Tuning base notes (MIDI numbers): G4 C4 E4 A4; A4 = 440Hz. */
const MIDI = { "G4":67, "C4":60, "E4":64, "A4":69 };
const STRINGS = [MIDI.G4, MIDI.C4, MIDI.E4, MIDI.A4];
function midiToFreq(m) { return 440 * Math.pow(2,(m-69)/12); }

/* --- UI refs */
const chordNameEl = document.getElementById('chordName');
const chordTypeEl = document.getElementById('chordType');
const diagram = document.getElementById('diagram');
const showFingering = document.getElementById('showFingering');
const nextBtn = document.getElementById('next');
const prevBtn = document.getElementById('prev');
const playBtn = document.getElementById('play');
const autoAdvance = document.getElementById('autoAdvance');
const scaleSel = document.getElementById('scale');
const strumStyle = document.getElementById('strumStyle');

let index = 0;
let filtered = CHORDS.slice();
let autoTimer = null;
let chordLoadCount = 0;
const tipRow = document.getElementById('tipRow');

/* --- Audio setup */

// const master = audioCtx.createGain();
// master.gain.value = 0.15; // overall volume control
// master.connect(audioCtx.destination);

// frequencies.forEach((f,i) => {
//   if (!f) return;
//   const t = now + i*0.03;
//   const o = audioCtx.createOscillator();
//   const g = audioCtx.createGain();
//   o.type = 'sine';
//   o.frequency.value = f;
//   o.connect(g);
//   g.connect(master);
//   g.gain.setValueAtTime(0, t);
//   g.gain.linearRampToValueAtTime(0.12, t+0.01);   // lower peak
//   g.gain.exponentialRampToValueAtTime(0.00001, t+2.4); // tiny positive
//   o.start(t);
//   o.stop(t+2.5);
// });


const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playChord(frequencies, style='down') {
  const now = audioCtx.currentTime;
  const master = audioCtx.createGain();
  master.gain.value = 0.25; // overall volume control
  master.connect(audioCtx.destination);

  if (style === 'down') {
    frequencies.forEach((f,i) => {
      if (!f) return;
      const t = now + i*0.03;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = f;
      g.gain.value = 0;
      o.connect(g);
      g.connect(master);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.9, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+2.4);
      o.start(t); o.stop(t+2.5);
    });
  } else {
    frequencies.forEach((f,i) => {
      if (!f) return;
      const t = now + i*0.2;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = f;
      g.gain.value = 0;
      o.connect(g);
      g.connect(master);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.86, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0002, t+3.5);
      o.start(t); o.stop(t+3.6);
    });
  }
}

/* --- Utility: compute played frequencies from fingering */
function chordToFrequencies(fingering) {
  return fingering.map((fret,i) => {
    if (fret === 'x' || fret === 'X') return null;
    const baseMidi = STRINGS[i];
    const midi = baseMidi + Number(fret);
    return midiToFreq(midi);
  });
}

/* --- Display logic */
function renderChord(ci) {
  const chord = filtered[ci];
  chordNameEl.textContent = chord.name;
  chordTypeEl.textContent = chord.type;
  chordLoadCount++;
  if (chordLoadCount > 3 && tipRow) {
    tipRow.classList.add('fade-out');
  }
  if (showFingering.checked) {
    diagram.style.display = 'block';
    drawDiagram(chord.fingering);
  } else {
    diagram.style.display = 'none';
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume().catch(()=>{});
  }
  const freqs = chordToFrequencies(chord.fingering);
  setTimeout(()=> playChord(freqs, strumStyle.value), 150);
}

/* --- Diagram drawing: uses CSS variables for colors */
function drawDiagram(fingering) {
  const ctx = diagram.getContext('2d');
  const w = diagram.width, h = diagram.height;
  ctx.clearRect(0,0,w,h);

  // Read CSS variables
  const styles = getComputedStyle(document.documentElement);
  const colorString = styles.getPropertyValue('--color-string').trim();
  const colorFret   = styles.getPropertyValue('--color-fret').trim();
  const colorLabel  = styles.getPropertyValue('--color-label').trim();
  const colorDot    = styles.getPropertyValue('--color-dot').trim();
  const colorMuted  = styles.getPropertyValue('--color-muted').trim();
  const colorDotText= styles.getPropertyValue('--color-dot-text').trim();

  const margin = 18;
  const nutH = 28;
  const cols = 4;
  const sx = margin;
  const sy = margin + nutH;
  const gw = w - margin*2;
  const gh = h - margin*2 - nutH;
  const stringX = Array.from({length:4},(_,i)=> Math.round(sx + (gw/(cols-1))*i));
  const fretY = [sy].concat(Array.from({length:4},(_,i)=> Math.round(sy + gh*(i+1)/4)));

  // strings
  ctx.strokeStyle = colorString;
  ctx.lineWidth = 2.2;
  for (let x of stringX) {
    ctx.beginPath();
    ctx.moveTo(x,sy-6);
    ctx.lineTo(x, fretY[fretY.length-1]+6);
    ctx.stroke();
  }

  // frets (including nut)
  ctx.strokeStyle = colorFret;
  ctx.lineWidth = 2;
  for (let i=0;i<fretY.length;i++){
    ctx.beginPath();
    ctx.moveTo(stringX[0]-8, fretY[i]);
    ctx.lineTo(stringX[stringX.length-1]+8, fretY[i]);
    ctx.stroke();
  }

  // string labels at top (G C E A)
  ctx.fillStyle = colorLabel; ctx.font = '12px system-ui';
  ['G','C','E','A'].forEach((s,i)=> ctx.fillText(s, stringX[i]-6, margin+10));

  // finger dots
  fingering.forEach((f,i)=>{
    const x = stringX[i];
    if (f === 'x' || f === 'X') {
      ctx.fillStyle = colorMuted; ctx.font='14px system-ui';
      ctx.fillText('x', x-5, sy-10);
    } else if (f === 0) {
      const cx = x;
      const cy = sy - 20; // same center as the circle

      // Draw circle
      ctx.fillStyle = colorDot;
      ctx.beginPath();
      ctx.arc(cx, cy, 10, 0, Math.PI * 2);
      ctx.fill();

      // Draw centered "o"
      ctx.save();
      ctx.fillStyle = colorDotText;
      ctx.font = '11px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('o', cx, cy);
      ctx.restore();
    } else {
      const fretIndex = Math.min(4, f);
      const yTop = fretY[fretIndex-1];
      const yBottom = fretY[fretIndex];
      const y = Math.round((yTop + yBottom)/2);
      ctx.fillStyle = colorDot;
      ctx.beginPath();
      ctx.arc(x,y,10,0,Math.PI*2);
      ctx.fill();
      if (f > 4) {
        ctx.fillStyle = colorDotText;
        ctx.font='11px system-ui';
        ctx.fillText(f, x-6, y+4);
      }
    }
  });
}

/* --- Navigation */
function filterChords() {
  const v = scaleSel.value;
  if (v === 'all') filtered = CHORDS.slice();
  else if (v === 'maj') filtered = CHORDS.filter(c=>c.type.toLowerCase().includes('major'));
  else if (v === 'min') filtered = CHORDS.filter(c=>c.type.toLowerCase().includes('minor'));
  else if (v === 'seventh') filtered = CHORDS.filter(c=>c.type.toLowerCase().includes('sevent'));
  if (index >= filtered.length) index = 0;
}
function showIndex(i) {
  index = (i + filtered.length) % filtered.length;
  renderChord(index);
}
function showRandomChord() {
  index = Math.floor(Math.random() * filtered.length);
  renderChord(index);
}
nextBtn.addEventListener('click', ()=> { showRandomChord(); });
prevBtn.addEventListener('click', ()=> { showIndex(index-1); });
playBtn.addEventListener('click', ()=> { renderChord(index); });
scaleSel.addEventListener('change', ()=> { filterChords(); showIndex(0); });
showFingering.addEventListener('change', ()=> { renderChord(index); });
strumStyle.addEventListener('change', ()=> { /* no-op */ });

/* keyboard shortcuts: space = next, left/right */
window.addEventListener('keydown', (e)=> {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.isContentEditable) return;
  if (e.code === 'Space' || e.code === 'ArrowRight') { 
    e.preventDefault(); 
    showRandomChord(); 
  }
  if (e.code === 'ArrowLeft') showIndex(index-1);
  
  if (e.key.toLowerCase() === 'c') {
    showFingering.checked = !showFingering.checked;
    renderChord(index);
  }
});

/* auto advance */
autoAdvance.addEventListener('change', ()=>{
  if (autoAdvance.checked) {
    autoTimer = setInterval(()=> showRandomChord(), 5000);
  } else {
    clearInterval(autoTimer); autoTimer = null;
  }
});

/* initial load */
filterChords();
index = Math.floor(Math.random() * filtered.length); // pick random starting chord
renderChord(index);
</script>
</body>
</html>